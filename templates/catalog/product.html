{% extends 'base.html' %}
{% load i18n catalog_tags core_tags embed_video_tags %}

{% block meta_title %}{{ product|get_product_meta_title:category }}{% endblock %}
{% block meta_desc %}{{ product.get_meta_desc }}{% endblock %}
{% block meta_keyw %}{{ product.get_meta_keyw }}{% endblock %}

{% block og_title %}{{ product|get_product_meta_title:category }}{% endblock %}
{% block og_desc %}{{ product.get_meta_desc }}{% endblock %}

{% block twitter_title %}{{ product|get_product_meta_title:category }}{% endblock %}
{% block twitter_desc %}{{ product.get_meta_desc }}{% endblock %}

{% block content %}
  <main>
    <div class="main_content">
      
      <ul id="touch_breadcrumb" class="breadcrumb">
        <li><a href="{% url 'home' %}">Главная</a></li>
        {% if sex == 'female' %}<li><a href="{% url 'women' %}">Женщинам</a></li>
        {% elif sex == 'male' %}<li><a href="{% url 'men' %}">Мужчинам</a></li>
        {% endif %}
        <li><a href="{{ category.get_absolute_url }}">{{ category.title }}</a></li>
        <li>{{ product.title }}</li>
      </ul>
    
      <div id="main_content" class="wrapp_content">
        <ul class="breadcrumb">
          <li><a href="{% url 'home' %}">Главная</a></li>
          {% if sex == 'female' %}<li><a href="{% url 'women' %}">Женщинам</a></li>
          {% elif sex == 'male' %}<li><a href="{% url 'men' %}">Мужчинам</a></li>
          {% endif %}
          <li><a href="{{ category.get_absolute_url }}">{{ category.title }}</a></li>
          <li>{{ product.title }}</li>
        </ul>

        <style>
          .ch_title_item._custom:after { content: none; }

          .usual_link {
            color: black !important;
            font-family: 'NeoRegular' !important;
            font-size: 14px;
            font-weight: bold !important;
            cursor: pointer;
          }
          .usual_link:hover {
            text-decoration: underline !important;
            color: black !important;
            background-color: #fff !important;
            border-color: #fff !important;
            border: none !important;
          }
        </style>

        <h1 class="title_block">{{ product.title }}</h1>
        {% if product.vendor_code %}
          <div style="margin: -20px 0 20px;"><span class="ch_title_item _custom">Артикул: </span>{{ product.vendor_code }}</div> 
        {% endif %}

        <div class="item_content_block">
        
        <!-- SLIDER ITEM >>> -->
          <div class="nom_img">
          <script language="javascript" src="/static/js/highslide/jquery.jcarousel.min.js"></script>
          <script type="text/javascript">
            {% include 'js/init_product_photos.js' %}
          </script>
          <!-- УВЕЛИЧЕНИЕ КАРТИНКИ -->
          <script type="text/javascript" src="/static/js/highslide/highslide-with-gallery.js"></script>
          <link rel="stylesheet" type="text/css" href="/static/js/highslide/highslide.css" />
          <script type="text/javascript">
            hs.graphicsDir = '/static/js/highslide/graphics/'; 
            hs.align = 'center';
            hs.transitions = ['expand', 'crossfade']; 
            hs.outlineType = 'rounded-white';
            hs.fadeInOut = true; 
            hs.dimmingOpacity = 0.5; 
            hs.addSlideshow({
              interval: 5000, 
              repeat: false, 
              useControls: true, 
              fixedControls: 'fit', 
              overlayOptions: { 
                opacity: 0.75, 
                position: 'bottom center', 
                hideOnMouseOut: true
              }
            });
          </script>
          <!-- УВЕЛИЧЕНИЕ КАРТИНКИ <<< -->
          
            
            <div class="{% if photos %}js-with-photos {% endif %}nom_img_med_wrap highslide-gallery">
              <ul class="nom_img_list js-photo-big-container">
                {% for photo in photos %}
                  <li class="js-photo-big" data-attrs="{{ photo.attrs_json }}" data-order="{{ forloop.counter }}">
                    <a href="{{ photo.big_url }}" target="_blank" class="highslide" onclick="return hs.expand(this)" title="">
                    <img src="{{ photo.preview_url }}" /></a>
                  </li>
                {% empty %}
                  <li>
                    <a href="{{ product.big_url }}" target="_blank" class="highslide" onclick="return hs.expand(this)" title="">
                    <img src="{{ product.preview_url }}" /></a>
                  </li>
                {% endfor %}
              </ul>
            </div>
            <div class="C_navigation">
              <div class="js-navigation-buttons">
                <div class="l_arr js-navigation-button" id="l_arr_nom_img"><img src="/static/i/arrow_slide.png" /></div>
                <div class="r_arr js-navigation-button" id="r_arr_nom_img"><img src="/static/i/arrow_slide.png" /></div>
              </div>
              <div class="carousel-navigation">
                <ul class="jcarousel js-photo-thumb-container">
                  {% for photo in photos %}
                    <li class="js-photo-thumb" data-attrs="{{ photo.attrs_json }}" data-order="{{ forloop.counter }}">
                      <img src="{{ photo.thumb_url }}" />
                    </li>
                  {% empty %}
                    <li class="">
                      <img src="{{ product.thumb_url }}" />
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% if attrs_ids|length %}
              <a href="#" class="move_butt_item js-wishlist-button">
                {% if in_wishlist %}Удалить из списка желаемых покупок{% else %}Добавить в список желаемых покупок{% endif %}
              </a>
              <input class="js-wishlist-input" type="checkbox" style="display: none;" name="wishlist"
                     {% if in_wishlist %} value="1" checked="checked"{% endif %}
                     data-add-url="{% url 'wishlist:add' %}" data-remove-url="{% url 'wishlist:remove' %}"
                     data-product-id="{{ wishlist_data.product_id }}" data-price="{{ wishlist_data.price }}"
                     data-attrs='{{ wishlist_data.attrs_json|safe }}' />
            {% endif %}
          </div>
          <div class="highslide-dimming"></div>
        <!-- SLIDER ITEM <<< -->
          
        <!-- FORM chars ITEM >>> -->
          <form class="wrapp_chars_item_cols" method="post" action="{% url 'cart_api:set' %}">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">

            <div class="chars_item_cols">
              {% for attr in attrs.color %}
                {% include 'catalog/include/product_attr.html' with attr=attr attr_type='color' choose_option=True %}
              {% endfor %}

              {% for attr in attrs.style %}
                {% include 'catalog/include/product_attr.html' with attr=attr attr_type='style' choose_option=True %}
              {% endfor %}

              {% for attr in attrs.size %}
                {% if not attr|had_neighbor:attrs_ids %}
                  {% include 'catalog/include/product_attr.html' with attr=attr attr_type='size' choose_option=True %}
                {% endif %}
              {% endfor %}

              {# ------------------------ #}

              {% if extra_products|length %}
                {% for extra_p in extra_products %}
                  <div style="margin: 10px 0 20px;">
                    <div style="border-top: 1px solid #f2f2f2; margin: 20px 0 30px;"></div>
                    <h2>{{ extra_p.title }}</h2>

                    {% for attr in extra_p.attrs.color %}
                      {% include 'catalog/include/product_attr.html' with attr=attr attr_type='color' extra_product_id=extra_p.id choose_option=False %}
                    {% endfor %}

                    {% for attr in extra_p.attrs.style %}
                      {% include 'catalog/include/product_attr.html' with attr=attr attr_type='style' attrs_ids=extra_p.attrs_ids extra_product_id=extra_p.id choose_option=False %}
                    {% endfor %}

                    {% for attr in extra_p.attrs.size %}
                      {% if not attr|had_neighbor:extra_p.attrs_ids %}
                        {% include 'catalog/include/product_attr.html' with attr=attr attr_type='size' extra_product_id=extra_p.id choose_option=False %}
                      {% endif %}
                    {% endfor %}
                  </div>

                {% endfor %}
              {% endif %}

              <div class="row_chars_item" style="width: 150%;">
                <script type="text/javascript" >
                  // ПЛЮС - МИНУС
                  $(document).ready(function() {
                    $('.minus').click(function () {
                      var $input = $(this).parent().find('input');
                      var count = parseInt($input.val()) - 1;
                      count = count < 1 ? 1 : count;
                      $input.val(count);
                      $input.change();
                      return false;
                    });
                    $('.plus').click(function () {
                      var $input = $(this).parent().find('input');
                      var count = parseInt($input.val()) + 1;
                      $input.val(count);
                      $input.change();
                      return false;
                    });
                  });
                </script>
                
                <script type="text/javascript" >
                  // ПЕРЕДАЁМ УМНОЖЕННУЮ ЦЕНУ В СКРЫТЫЙ input=hidden => price-item
                  $(document).ready(function() {
                    $('#cnt_item').change('keyup input', function() {
                      var value = this.value;
                      updateCount(value);
                      // if (value > 0) {
                      // $("#price_ID-373").html(value * {{ price }});
                      // $("#price-hidd-val").val(value * {{ price }});
                      // }
                    });
                  });
                </script>
                
                <div class="filtr_title ch_title_item">Кол-во:</div>
                <div class="number js-hide-if-not-option"{% if not have_option %} style="display: none;"{% endif %}>
                  <span class="minus">-</span>
                  <input type="text" name="count_item" value="{{ count }}" maxlength="3" onkeyup="this.value = this.value.replace (/\D/, '')" id="cnt_item" />
                  <span class="plus" id="plus">+</span>
                </div>

                {% if discount %}
                  <div class="js-hide-if-not-option"{% if not have_option %} style="display: none;"{% endif %}>
                    <div class="txt_price_to">Цена для вас:</div>
                    <div class="product_price sale_price"><s class="js-base-price" style="font-family: NeoRegular;">{{ price|to_int_plus }}</s><abbr title="руб">р.</abbr></div>
                    <div class="product_price" style="color: #8c2c34;"><span class="js-cart-price">{{ price|with_discount:discount }}</span><abbr title="руб">р.</abbr></div>
                  </div>
                {% else %}
                  <div class="product_price js-hide-if-not-option"><span id="price_ID-373" class="js-cart-price">{{ price }}</span><abbr title="руб">р.</abbr></div>
                {% endif %}

                <input type="hidden" name="price-item" id="price-hidd-val" value="{{ price }}">
                <div class="button-div"{% if discount %} style="clear: both;"{% endif %}>
                  {% if not have_option %}
                    <button class="js-cart-button to_cart_list _disabled" data-type="none" type="submit">Такого товара нет в наличии</button>
                  {% elif count > maximum_in_stock %}
                    <button class="js-cart-button to_cart_list" data-type="order" type="submit">Под заказ</button>
                  {% else %}
                    <button class="js-cart-button to_cart_list" data-type="add" type="submit">В корзину</button>
                  {% endif %}
                  
                  <label for="pak" class="check_pr_input checke_lab js-hide-if-not-option"{% if not have_option %} style="display: none;"{% endif %}>
                    <input type="checkbox" class="js-gift-wrapping-trigger" data-wrapping-price="{{ gift_wrapping_price|to_int_str }}" name="gift_wrapping" id="pak" value="1" />
                    <abbr class="abbr_check">Подарочная<br />упаковка</abbr>
                    
                    <div class="product_price"><span id="price_ID--gift-wrapping">{{ gift_wrapping_price|to_int_str }}</span><abbr title="руб">р.</abbr></div>
                  </label>
                </div>
              </div>
              
            </div>
          </form>
        <!-- FORM chars ITEM <<< -->
          
        </div>

        {% if product.text or product.videos.count %}
          <div class="text_preview_page text_item">
            <div class="text_preview_inner">
              {% if product.text %}
                {{ product.text|safe }}
              {% endif %}
              
              <div id="player_item">
                {% for v in product.videos.all %}
                  <div class="wrapp_player_item js-video-item" style="display: {% if forloop.counter > 1 %}none{% else %}block{% endif %}">
                    {% video v.video '100%x453' %}
                    {# <div class="inner_player_item" style="background-image:url(/static/images/picture_video2.jpg);"> #}
                    {# </div> #}
                    {# <a href="#" onclick="return false" class="play">play</a> #}
                  </div>
                {% endfor %}
                {% if product.videos.count > 1 %}
                  <div class="bt_req_call"><a href="#" class="js-expand-videos">Смотреть всё видео</a></div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endif %}

        {% if product.also_products.count %}
          <h2 class="title_block">С этим товаром также покупают:</h2>
          <div class="item_list_wrapp" itemscope="" itemtype="http://schema.org/ItemList">
            {% for also_p in product.also_products.all %}
              <div class="product_list">
                <div class="photo_list"><a href="{{ also_p.get_absolute_url }}"><img src="{{ also_p.cover_thumb }}" alt="{{ also_p.title }}" /></a></div>
                <h3><a href="{{ also_p.get_absolute_url }}">{{ also_p.title }}</a></h3>
                <h4>{{ also_p.subtitle }}</h4>
                <div class="product_price">{{ also_p.get_price_rub }}<abbr title="руб">р.</abbr></div>
                <a href="{{ also_p.get_absolute_url }}" class="to_cart_list">В корзину</a>
              </div>
            {% endfor %}
          </div>
        {% endif %}

      </div>
    </div>
  </main>
{% endblock %}

{% block popups %}
  <div style="display: none">
    <a rel="leanModal1" href="#error-popup"></a>
    <a rel="leanModal1" href="#success-popup"></a>
  </div>

  <div class="window_popap no_float mini_window_popup callback_form" id="error-popup" style="display:none;">
      <div class="close_popap call_close js-call-close"><img src="/static/i/close_white_45.png" alt="Закрыть"></div>
      <div class="wrap_window_popap bg_wrapp_window">
          <div class="popap_row">
              <div class="popap_row_wrapp">
                  <h3 class="popup_title" style="margin-bottom: 10px;">Пожалуйста, выберите одно из нескольких значений:</h3>
                  <p class="call_introtext popup_text"></p>
                  {% comment %}
                  <div class="red_bor_butt">
                      <span class="js-call-close usual_link">Закрыть</span>
                  </div>
                  {% endcomment %}
                  <div class="bt_req_call red_bor_butt js-call-close">
                    <button class="butt_border">Закрыть</button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="window_popap no_float mini_window_popup callback_form" id="success-popup" style="display:none;">
      <div class="close_popap call_close js-call-close"><img src="/static/i/close_white_45.png" alt="Закрыть"></div>
      <div class="wrap_window_popap bg_wrapp_window">
          <div class="popap_row">
              <div class="popap_row_wrapp">
                  <h3 class="popup_title" style="margin-bottom: 10px;">Товар добавлен в корзину!</h3>
                  <p class="call_introtext popup_text">
                    Товаров в корзине: <span class="js-cart-count">{{ cart.count }}</span><br/>
                    Общая сумма: <span class="js-cart-summary">{{ cart.summary }}</span> р.<br/>
                  </p>
                  <div class="red_bor_butt">
                    <div class="bt_req_call">
                      <a href="/cart/" class="butt_border">Перейти к корзине</a>
                    </div>
                    {# <span class="js-call-close usual_link">Продолжить покупки</span> #}
                    <a href="{% url 'women' %}" class="usual_link">Продолжить покупки</a>
                  </div>
              </div>
          </div>
      </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script type="text/javascript">
    window.data = {{ data_json|safe }};
    {% include 'js/wishlist.js' %}
    {% include 'js/product.js' %}
    $(function(){
      options = filterOptions(['style']);
      // updateShownCheckboxes(options, ['color', 'size']);
      chooseOption(true, true);
    });
  </script>
{% endblock %}
